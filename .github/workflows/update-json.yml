name: Update IPTV JSON List
on:
  workflow_dispatch:
  schedule:
    - cron: '*/20 * * * *'

jobs:
  generate-json:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - name: Fetch and Convert M3U to JSON
        run: |
          curl -s -L "https://raw.githubusercontent.com/minhtan001/IPTV-Auto/refs/heads/playlists/all.m3u" > raw.m3u
          
          cat << 'EOF' > convert.py
          import json
          import re

          # HÃ m thÃ´ng minh Ä‘á»ƒ bÃ³c tÃ¡ch vÃ  sáº¯p xáº¿p thá»i gian
          def get_sort_key(t_str):
              # Lá»c ra giá», phÃºt, vÃ  ngÃ y/thÃ¡ng (náº¿u cÃ³)
              m = re.search(r'(\d{1,2})[hH:](\d{2})(?:-(\d{1,2})/(\d{1,2}))?', t_str)
              if m:
                  hour = int(m.group(1))
                  minute = int(m.group(2))
                  day = int(m.group(3)) if m.group(3) else 0
                  month = int(m.group(4)) if m.group(4) else 0
                  # Tráº£ vá» bá»™ sá»‘ Ä‘á»ƒ Python tá»± Ä‘á»™ng Æ°u tiÃªn xáº¿p háº¡ng
                  return (month, day, hour, minute)
              return (99, 99, 99, 99) # Bá» xuá»‘ng Ä‘Ã¡y náº¿u khÃ´ng báº¯t Ä‘Æ°á»£c giá»

          data = {
            "id": "HFB",
            "url": "http://hfb123.netlify.app/MT.json",
            "name": "HFB",
            "color": "#1cb57a",
            "description": "HFB - Trang web phÃ¡t sÃ³ng bÃ³ng Ä‘Ã¡ trá»±c tuyáº¿n miá»…n phÃ­.",
            "image": {
              "url": "https://t4.ftcdn.net/jpg/02/11/51/53/360_F_211515361_bnIbyKadClzn3hJT0zCPPuPApcG7k3lC.jpg"
            },
            "groups": [
              {
                "id": "live",
                "name": "ðŸ”´ Lá»‹ch PhÃ¡t SÃ³ng",
                "display": "vertical",
                "grid_number": 1,
                "channels": []
              }
            ],
            "sorts": [],
            "notice": {
              "id": "notice",
              "link": "",
              "icon": "",
              "closeable": True
            },
            "option": {
              "save_history": False,
              "save_search_history": False,
              "save_wishlist": False
            }
          }

          try:
              with open('raw.m3u', 'r', encoding='utf-8') as f:
                  lines = [line.strip() for line in f if line.strip()]
          except Exception as e:
              lines = []

          channels_with_sort_key = []
          uid = 1

          for i in range(len(lines)):
              line = lines[i]
              
              if line.startswith('#EXTINF') and 'Socolive' in line:
                  parts = line.split(',', 1)
                  if len(parts) > 1:
                      display_text = parts[1].strip()
                      
                      match_info = re.match(r'(.*?):\s*\[(.*?)\]\s*(.*)', display_text)
                      
                      if match_info:
                          time_str = match_info.group(1).strip()
                          blv_name = match_info.group(2).strip()
                          match_name = match_info.group(3).strip()
                      else:
                          time_str = "00h00"
                          blv_name = "BLV Socolive"
                          match_name = display_text

                      if i + 1 < len(lines) and lines[i+1].startswith('http'):
                          raw_url = lines[i+1]
                          id_match = re.search(r'id=(\d+)', raw_url)
                          
                          if id_match:
                              stream_id = id_match.group(1)
                              new_stream_url = f"https://live.inplyr.com/room/{stream_id}.m3u8"
                              unique_match_name = f"{match_name} ({blv_name})"
                              
                              # Cáº¥u trÃºc 1 tráº­n Ä‘áº¥u
                              channel_obj = {
                                "id": f"ch-{uid}",
                                "name": unique_match_name,
                                "labels": [
                                  { "position": "bottom-left", "text": blv_name, "color": "#0066CC", "text_color": "#FFFFFF" },
                                  { "position": "center", "text": time_str, "color": "#0066CC", "text_color": "#FFFFFF" }
                                ],
                                "description": f"Socolive â€¢ {time_str}",
                                "image": {
                                  "url": "https://raw.githubusercontent.com/nghehoang007-wq/HFB321/main/HFB/Thump/nguonphat1.png",
                                  "height": 480, "width": 640, "display": "cover", "shape": "square"
                                },
                                "type": "single",
                                "display": "text-below",
                                "sources": [
                                  {
                                    "id": f"src-{uid}",
                                    "name": "Socolive",
                                    "contents": [
                                      {
                                        "id": f"cnt-{uid}",
                                        "name": unique_match_name,
                                        "streams": [
                                          {
                                            "id": f"strm-{uid}",
                                            "name": blv_name,
                                            "stream_links": [
                                              {
                                                "id": f"lnk-{uid}",
                                                "name": "HLS",
                                                "type": "hls",
                                                "default": True,
                                                "url": new_stream_url,
                                                "request_headers": [
                                                  { "key": "Referer", "value": "https://bunchatv3.com/" }
                                                ]
                                              }
                                            ]
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              }
                              
                              # Sinh khÃ³a sáº¯p xáº¿p thá»i gian vÃ  thÃªm vÃ o danh sÃ¡ch chá»
                              sort_key = get_sort_key(time_str)
                              channels_with_sort_key.append((sort_key, channel_obj))
                              uid += 1

          # Thá»±c thi lá»‡nh sáº¯p xáº¿p tá»± Ä‘á»™ng dá»±a trÃªn khÃ³a thá»i gian
          channels_with_sort_key.sort(key=lambda x: x[0])
          
          # Äáº©y danh sÃ¡ch Ä‘Ã£ sáº¯p xáº¿p gá»n gÃ ng vÃ o cá»¥c JSON
          data['groups'][0]['channels'] = [item[1] for item in channels_with_sort_key]

          with open('MT.json', 'w', encoding='utf-8') as f:
              json.dump(data, f, ensure_ascii=False, indent=2)
          EOF
          
          python3 convert.py
          
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add MT.json
          git commit -m "UI Upgrades: Vertical scroll, sorting by time, text-below" || echo "No changes to commit"
          git push
