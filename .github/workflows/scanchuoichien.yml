name: Generate JSON from ChuoiChien
on:
  workflow_dispatch:
  schedule:
    - cron: '*/20 * * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - name: Install Dependencies
        run: pip install curl_cffi

      - name: Run ChuoiChien JSON Factory
        run: |
          rm -rf stream
          mkdir stream
          
          cat << 'EOF' > scraper.py
          import os
          import json
          import re
          from datetime import datetime, timedelta, timezone
          from curl_cffi import requests

          # ================= C·∫§U H√åNH API =================
          API_URL = "https://api.chuoichientv.com/v1/matches?page=1&limit=100&sport=&type=blv"
          BASE_REMOTE_URL = "https://raw.githubusercontent.com/nghehoang007-wq/HFB321/main/stream/" 

          HEADERS = {
              "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJndWVzdElkIjoiZTM0Zjk3ZmQtNWMxMC00MGEzLWE1OGYtZDE3MmQwMmIxNDZjIiwidHlwZSI6Imd1ZXN0IiwiaXAiOiIxNjIuMTU5Ljk4LjIyMCIsInVzZXJBZ2VudCI6Ik1vemlsbGEvNS4wIChXaW5kb3dzIE5UIDEwLjA7IFdpbjY0OyB4NjQpIEFwcGxlV2ViS2l0LzUzNy4zNiAoS0hUTUwsIGxpa2UgR2Vja28pIENocm9tZS8xMzEuMC4wLjAgU2FmYXJpLzUzNy4zNiIsIm5hbWUiOiJCw7puIMSQ4buPIDQ1MyIsInRpbWVzdGFtcCI6MTc3MjI5MTc4NzEwNCwiaWF0IjoxNzcyMjkxNzg3LCJleHAiOjE4MDM4Mjc3ODd9.iHhwdQaDRcrjyRfCVGCbSZb6dFj-EuzJblTD1wmttV0",
              "Origin": "https://live16.chuoichientv.com",
              "Referer": "https://live16.chuoichientv.com/",
              "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
          }

          tz_vn = timezone(timedelta(hours=7))

          def shorten_name(name):
              name = str(name).strip()
              known = {"Manchester United": "Man Utd", "Manchester City": "Man City", "Barcelona": "Barca", "Villarreal": "Villarr"}
              for k, v in known.items():
                  if k.lower() in name.lower(): return v
              return name[:12] + ".." if len(name) > 13 else name

          try:
              print("ƒêang c·∫•y gh√©p d·ªØ li·ªáu t·ª´ X-Ray JSON...")
              response = requests.get(API_URL, headers=HEADERS, impersonate="chrome110", timeout=30)
              data = response.json()
              matches = data.get('matches', [])

              master_json = {
                  "id": "chuoichienhfb",
                  "url": "https://nghehoang007-wq.github.io/HFB321/chuoichientv.json",
                  "name": "Chu·ªëi Chi√™n TV",
                  "color": "#003A17",
                  "description": "C·∫≠p nh·∫≠t tr·ª±c ti·∫øp t·ª´ Chu·ªëi Chi√™n TV",
                  "image": {"url": "https://raw.githubusercontent.com/nghehoang007-wq/HFB321/main/HFB/Thump/chuoichien.png?v1"},
                  "groups": [{"id": "live", "name": "üî¥ TR·ª∞C TI·∫æP CHU·ªêI CHI√äN", "display": "vertical", "grid_number": 2, "channels": []}],
                  "notice": {"id": "notice", "link": "https://t.me/xemgicungshare", "icon": "https://tt.8share.pro/assets/telegram_sp.png", "closeable": True},
                  "option": {"save_history": False, "save_search_history": False, "save_wishlist": False}
              }
              
              for match in matches:
                  try:
                      match_id = match.get('_id')
                      
                      # T·ªåA ƒê·ªò CHU·∫®N T·ª™ X-RAY
                      home_data = match.get('teams', {}).get('home', {})
                      away_data = match.get('teams', {}).get('away', {})
                      
                      team1_full = home_data.get('name', 'Home')
                      team2_full = away_data.get('name', 'Away')
                      team1_short = shorten_name(team1_full)
                      team2_short = shorten_name(team2_full)

                      # X·ª≠ l√Ω th·ªùi gian
                      match_time_raw = match.get('matchTime', '')
                      time_display = "00h00"
                      if match_time_raw:
                          dt = datetime.strptime(match_time_raw, "%Y-%m-%dT%H:%M:%0.000Z").replace(tzinfo=timezone.utc).astimezone(tz_vn)
                          time_display = dt.strftime("%Hh%M")

                      blvs = match.get('blvs', [])
                      if not blvs: continue
                      blv = blvs[0]
                      blv_name = blv.get('name', 'Chu·ªëi')
                      streams = blv.get('streams', [])
                      if not streams: continue

                      # -- T·∫†O FILE JSON CON (REFERER L√ÅCH LU·∫¨T) --
                      child_json = {"stream_links": []}
                      master_streams = []
                      for idx, s in enumerate(streams):
                          s_url = s.get('url')
                          s_name = f"{blv_name} - {s.get('label', 'HD')}"
                          child_json["stream_links"].append({
                              "id": str(idx+1), "name": s_name, "type": "hls" if "m3u8" in s_url else "flv",
                              "url": s_url, "default": idx==0,
                              "request_headers": [{"key": "Referer", "value": "https://api.chuoichientv.com/"}]
                          })
                          master_streams.append({"id": f"{match_id}_{idx}", "name": s_name, "remote_data": {"url": f"{BASE_REMOTE_URL}{match_id}.json"}})

                      with open(f"stream/{match_id}.json", "w", encoding="utf-8") as f:
                          json.dump(child_json, f, ensure_ascii=False, indent=2)

                      # -- GIAO DI·ªÜN S·∫†CH 16:9 + L·ªíNG LOGO --
                      labels = [
                          {"position": "bottom-center", "text": time_display, "color": "#FF0000", "text_color": "#FFFFFF"},
                          {"position": "center-left", "text": team1_short, "color": "#80000000", "text_color": "#FFFFFF"},
                          {"position": "center-right", "text": team2_short, "color": "#80000000", "text_color": "#FFFFFF"},
                          {"position": "top-left", "text": "", "image": home_data.get('logo', '')},
                          {"position": "top-right", "text": "", "image": away_data.get('logo', '')}
                      ]

                      master_json["groups"][0]["channels"].append({
                          "id": match_id, "name": f"{team1_full} vs {team2_full}",
                          "labels": labels,
                          "image": {"url": "https://raw.githubusercontent.com/nghehoang007-wq/HFB321/main/HFB/Thump/nguonphat5.png", "height": 360, "width": 640, "display": "cover"},
                          "type": "single", "display": "thumbnail-only",
                          "sources": [{"id": f"src-{match_id}", "name": "Chu·ªëi Chi√™n", "contents": [{"id": f"c-{match_id}", "name": f"{team1_full} vs {team2_full}", "streams": master_streams}]}]
                      })
                  except: continue

              with open('chuoichientv.json', 'w', encoding='utf-8') as f:
                  json.dump(master_json, f, ensure_ascii=False, indent=2)
              print("üéâ TH√ÄNH C√îNG R·ª∞C R·ª†!")
          except Exception as e: print(f"L·ªói: {e}")
          EOF
          python3 scraper.py

      - name: Commit and Push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add -A stream/
          git add chuoichientv.json
          git commit -m "UI 16:9 + Logo Teams + Correct API Path" || echo "No changes"
          git push
