name: Generate JSON from ChuoiChien
on:
  workflow_dispatch:
  schedule:
    - cron: '*/20 * * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - name: Install Dependencies
        run: pip install curl_cffi

      - name: Run ChuoiChien JSON Factory
        run: |
          # D·ªçn d·∫πp th∆∞ m·ª•c c≈© ƒë·ªÉ kh√¥ng l∆∞u file r√°c c·ªßa tr·∫≠n ƒë√£ h·∫øt gi·ªù
          rm -rf stream
          mkdir stream
          
          cat << 'EOF' > scraper.py
          import os
          import json
          import re
          from datetime import datetime
          from curl_cffi import requests

          # ================= C·∫§U H√åNH =================
          API_URL = "https://api.chuoichientv.com/v1/matches?page=1&limit=100&sport=&type=blv"
          
          # ƒê∆∞·ªùng d·∫´n tr·ªè t·ªõi th∆∞ m·ª•c file con. ƒê√£ setup chu·∫©n theo Github c·ªßa b√°c.
          # N·∫øu b√°c d√πng domain ngo√†i, h√£y ƒë·ªïi th√†nh: "https://tt.8share.pro/chuoichien/stream/"
          BASE_REMOTE_URL = "https://raw.githubusercontent.com/nghehoang007-wq/HFB321/main/stream/" 

          HEADERS = {
              "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJndWVzdElkIjoiZTM0Zjk3ZmQtNWMxMC00MGEzLWE1OGYtZDE3MmQwMmIxNDZjIiwidHlwZSI6Imd1ZXN0IiwiaXAiOiIxNjIuMTU5Ljk4LjIyMCIsInVzZXJBZ2VudCI6Ik1vemlsbGEvNS4wIChXaW5kb3dzIE5UIDEwLjA7IFdpbjY0OyB4NjQpIEFwcGxlV2ViS2l0LzUzNy4zNiAoS0hUTUwsIGxpa2UgR2Vja28pIENocm9tZS8xMzEuMC4wLjAgU2FmYXJpLzUzNy4zNiIsIm5hbWUiOiJCw7puIMSQ4buPIDQ1MyIsInRpbWVzdGFtcCI6MTc3MjI5MTc4NzEwNCwiaWF0IjoxNzcyMjkxNzg3LCJleHAiOjE4MDM4Mjc3ODd9.iHhwdQaDRcrjyRfCVGCbSZb6dFj-EuzJblTD1wmttV0",
              "Origin": "https://live16.chuoichientv.com",
              "Referer": "https://live16.chuoichientv.com/",
              "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
          }

          try:
              print("Ti·∫øn h√†nh n·ªï m√°y s·∫£n xu·∫•t JSON...")
              response = requests.get(API_URL, headers=HEADERS, impersonate="chrome110", timeout=30)
              data = response.json()
              matches = data.get('matches', [])

              # 1. KH·ªûI T·∫†O B·ªò KHUNG MASTER JSON
              master_json = {
                  "id": "chuoichien",
                  "url": "https://tt.8share.pro/chuoichien",
                  "name": "Chu·ªëi Chi√™n TV",
                  "color": "#003A17",
                  "description": "Xem b√≥ng ƒë√° tr·ª±c tuy·∫øn HD kh√¥ng qu·∫£ng c√°o t·∫°i Chu·ªëi Chi√™n TV.",
                  "image": {"url": "https://tt.8share.pro/assets/chuoichien_logo.png"},
                  "groups": [
                      {
                          "id": "live",
                          "name": "üî¥ Tr·ª±c ti·∫øp",
                          "display": "vertical",
                          "channels": []
                      },
                      {
                          "id": "related",
                          "name": "Ch√°n ∆∞, v·∫≠y xem c√°i n√†y cho vui ^^",
                          "display": "horizontal",
                          "grid_number": 1,
                          "groups": [
                              {"id": "thapcamtv", "name": "ThapcamTV", "display": "text-below", "image": {"url": "https://thapcamiptv.com/10cam-logo-app-light.jpg", "height": 100, "width": 100, "display": "cover"}, "remote_data": {"url": "monplayer://monplayer.org?link=https%3A%2F%2Ftctv.pro&type=provider", "external": True}},
                              {"id": "vebotv", "name": "VeboTV", "display": "text-below", "image": {"url": "https://vebo.thethaoiptv.com/vebo-icon.png", "height": 100, "width": 100, "display": "cover"}, "remote_data": {"url": "monplayer://monplayer.org?link=https%3A%2F%2Fvbtv.pro&type=provider", "external": True}}
                          ]
                      }
                  ],
                  "notice": {"id": "notice", "link": "https://t.me/xemgicungshare", "icon": "https://tt.8share.pro/assets/telegram_sp.png", "closeable": True},
                  "option": {"save_history": False, "save_search_history": False, "save_wishlist": False}
              }
              
              count = 0
              for match in matches:
                  try:
                      match_id = match.get('_id', str(count))
                      home = match.get('home', {}).get('name') or "Home"
                      away = match.get('away', {}).get('name') or "Away"
                      match_name = f"{home} vs {away}"
                      
                      # T·ª∑ s·ªë
                      score_str = "- "
                      home_score = match.get('home', {}).get('score')
                      away_score = match.get('away', {}).get('score')
                      if home_score is not None and away_score is not None:
                          score_str = f"{home_score} - {away_score}"

                      # Th·ªùi gian (ƒê·ªïi v·ªÅ d·∫°ng 13/02/2026 17:45)
                      time_str = "00:00"
                      timestamp = match.get('timestamp') or match.get('matchTime')
                      if timestamp:
                          if isinstance(timestamp, (int, float)):
                              if timestamp > 1e11: timestamp /= 1000
                              dt = datetime.fromtimestamp(timestamp)
                              time_str = dt.strftime("%d/%m/%Y %H:%M")

                      blvs = match.get('blvs', [])
                      if not blvs: continue
                      blv = blvs[0]
                      blv_name = blv.get('name', 'BLV Chu·ªëi')
                      streams = blv.get('streams', [])
                      if not streams: continue

                      # 2. CH·∫æ T·∫†O FILE JSON CON CHO T·ª™NG TR·∫¨N
                      child_json = {"stream_links": []}
                      master_streams = []
                      
                      for idx, stream in enumerate(streams):
                          stream_label = stream.get('label', f"Lu·ªìng {idx+1}")
                          stream_url = stream.get('url')
                          stream_name = f"{blv_name} - {stream_label}"
                          
                          # N·∫°p c·∫•u tr√∫c l√°ch lu·∫≠t v√†o file con
                          child_json["stream_links"].append({
                              "id": str(idx + 1),
                              "name": stream_name,
                              "type": "hls",
                              "default": True if idx == 0 else False,
                              "url": stream_url,
                              "request_headers": [{"key": "Referer", "value": "https://api.chuoichientv.com/"}]
                          })
                          
                          # C·∫•y ƒë∆∞·ªùng link tr·ªè t·ªõi file con v√†o Master JSON
                          remote_url = f"{BASE_REMOTE_URL}{match_id}.json"
                          master_streams.append({
                              "id": f"{match_id}_{idx}",
                              "name": stream_name,
                              "remote_data": {"url": remote_url}
                          })

                      # Ghi file con ra th∆∞ m·ª•c stream/
                      with open(f"stream/{match_id}.json", "w", encoding="utf-8") as f:
                          json.dump(child_json, f, ensure_ascii=False, indent=2)

                      # 3. NH√öNG D·ªÆ LI·ªÜU V√ÄO MASTER JSON
                      match_entry = {
                          "id": match_id,
                          "name": match_name,
                          "labels": [
                              {"position": "top-right", "text": "‚óè Live", "color": "#FF0000", "text_color": "#FFFFFF"},
                              {"position": "bottom-left", "text": blv_name, "color": "#007BFF", "text_color": "#FFFFFF"},
                              {"position": "center", "text": score_str, "color": "#28A745", "text_color": "#FFFFFF"}
                          ],
                          "description": f"{match_name} - {time_str}",
                          "image": {"url": match.get('home', {}).get('logo', 'https://tt.8share.pro/images/cache/match-default.png'), "height": 480, "width": 640, "display": "cover", "shape": "square"},
                          "type": "single",
                          "display": "thumbnail-only",
                          "sources": [
                              {
                                  "id": f"chuoichien-source-{match_id}",
                                  "name": "Chu·ªëi Chi√™n TV",
                                  "contents": [
                                      {
                                          "id": f"chuoichien-content-{match_id}",
                                          "name": match_name,
                                          "streams": master_streams
                                      }
                                  ]
                              }
                          ]
                      }
                      master_json["groups"][0]["channels"].append(match_entry)
                      count += 1
                      
                  except Exception as ex:
                      print(f"L·ªói xu·∫•t JSON 1 tr·∫≠n: {ex}")
                      continue

              # L∆∞u file Master ch·ªët h·∫°
              with open('chuoichientv.json', 'w', encoding='utf-8') as f:
                  json.dump(master_json, f, ensure_ascii=False, indent=2)
                  
              print(f"üéâ HO√ÄN T·∫§T: T·∫°o th√†nh c√¥ng 1 file Master v√† {count} file JSON con l√°ch lu·∫≠t!")

          except Exception as e:
              print(f"‚ùå L·ªói h·ªá th·ªëng: {e}")
          EOF
          
          python3 scraper.py

      - name: Commit and Push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          # Quan tr·ªçng: Add c·∫£ file master v√† to√†n b·ªô th∆∞ m·ª•c stream ch·ª©a file con
          git add chuoichientv.json stream/
          git commit -m "Auto Build Remote-Control JSON Factory" || echo "No changes"
          git push
