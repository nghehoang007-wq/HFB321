name: Generate JSON from ChuoiChien
on:
  workflow_dispatch:
  schedule:
    - cron: '*/20 * * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - name: Install Dependencies
        run: pip install curl_cffi

      - name: Run ChuoiChien JSON Factory
        run: |
          rm -rf stream
          mkdir stream
          
          cat << 'EOF' > scraper.py
          import os
          import json
          import re
          from datetime import datetime, timedelta, timezone
          from curl_cffi import requests
          import unicodedata

          # ================= C·∫§U H√åNH API =================
          API_URL = "https://api.chuoichientv.com/v1/matches?page=1&limit=100&sport=&type=blv"
          BASE_REMOTE_URL = "https://raw.githubusercontent.com/nghehoang007-wq/HFB321/main/stream/" 

          HEADERS = {
              "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJndWVzdElkIjoiZTM0Zjk3ZmQtNWMxMC00MGEzLWE1OGYtZDE3MmQwMmIxNDZjIiwidHlwZSI6Imd1ZXN0IiwiaXAiOiIxNjIuMTU5Ljk4LjIyMCIsInVzZXJBZ2VudCI6Ik1vemlsbGEvNS4wIChXaW5kb3dzIE5UIDEwLjA7IFdpbjY0OyB4NjQpIEFwcGxlV2ViS2l0LzUzNy4zNiAoS0hUTUwsIGxpa2UgR2Vja28pIENocm9tZS8xMzEuMC4wLjAgU2FmYXJpLzUzNy4zNiIsIm5hbWUiOiJCw7puIMSQ4buPIDQ1MyIsInRpbWVzdGFtcCI6MTc3MjI5MTc4NzEwNCwiaWF0IjoxNzcyMjkxNzg3LCJleHAiOjE4MDM4Mjc3ODd9.iHhwdQaDRcrjyRfCVGCbSZb6dFj-EuzJblTD1wmttV0",
              "Origin": "https://live16.chuoichientv.com",
              "Referer": "https://live16.chuoichientv.com/",
              "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
          }

          # ================= H√ÄM X·ª¨ L√ù GIAO DI·ªÜN =================
          tz_vn = timezone(timedelta(hours=7))

          def shorten_name(name):
              name = name.strip()
              known = {
                  "Manchester United": "Man Utd", "Manchester City": "Man City", "Paris Saint Germain": "PSG",
                  "Wolverhampton Wanderers": "Wolves", "Wolverhampton": "Wolves", "Borussia Dortmund": "Dortmund",
                  "Borussia Monchengladbach": "M'gladbach", "Nottingham Forest": "N. Forest", "Bayer 04 Leverkusen": "Leverkusen",
                  "Eintracht Frankfurt": "E. Frankfurt", "Sporting Kansas City": "Sporting KC", "Club Deportivo Guadalajara": "Guadalajara",
                  "Preah Khan Reach Svay Rieng FC": "Svay Rieng", "Crystal Palace": "C. Palace", "Aston Villa": "A. Villa",
                  "Sheffield Wednesday": "Sheff Wed", "Sheffield United": "Sheff Utd", "Los Angeles FC": "LAFC", "Inter Miami CF": "Inter Miami"
              }
              for k, v in known.items():
                  if k.lower() in name.lower(): return v

              words_to_remove = ["FC", "CF", "SC", "AFC", "Club"]
              words = name.split()
              if len(words) > 1:
                  words = [w for w in words if w not in words_to_remove]
              res = " ".join(words)
              
              if len(res) > 13 and len(words) >= 2:
                  res = f"{words[0][0]}. " + " ".join(words[1:])
              if len(res) > 14:
                  res = res[:12] + ".."
              return res

          # ================= C√ÄO V√Ä X√ÇY D·ª∞NG JSON =================
          try:
              print("B·∫Øt ƒë·∫ßu c√†o API Chu·ªëi Chi√™n v√† d·ª±ng giao di·ªán T·ªëi Gi·∫£n...")
              response = requests.get(API_URL, headers=HEADERS, impersonate="chrome110", timeout=30)
              data = response.json()
              matches = data.get('matches', [])

              # 1. KH·ªûI T·∫†O B·ªò KHUNG MASTER JSON (ƒê√£ x√≥a Related Channels)
              master_json = {
                  "id": "chuoichien",
                  "url": "https://nghehoang007-wq.github.io/HFB321/chuoichientv.json",
                  "name": "Chu·ªëi Chi√™n TV",
                  "color": "#003A17",
                  "description": "Xem b√≥ng ƒë√° tr·ª±c tuy·∫øn HD kh√¥ng qu·∫£ng c√°o t·∫°i Chu·ªëi Chi√™n TV.",
                  "image": {"url": "https://raw.githubusercontent.com/nghehoang007-wq/HFB321/main/HFB/Thump/chuoichien.png"},
                  "groups": [
                      {
                          "id": "live",
                          "name": "üî¥ Tr·ª±c ti·∫øp (Chu·ªëi Chi√™n)",
                          "display": "vertical",
                          "grid_number": 2, # ƒê∆∞a grid_number v√†o ƒë√¢y ƒë·ªÉ Player chia 2 c·ªôt ƒë·∫πp h∆°n
                          "channels": []
                      }
                  ],
                  "sorts": [],
                  "notice": {"id": "notice", "link": "https://t.me/xemgicungshare", "icon": "https://tt.8share.pro/assets/telegram_sp.png", "closeable": True},
                  "option": {"save_history": False, "save_search_history": False, "save_wishlist": False}
              }
              
              count = 0
              for match in matches:
                  try:
                      match_id = match.get('_id', str(count))
                      
                      # T√™n ƒë·ªôi
                      home_obj = match.get('home', {}) or match.get('homeTeam', {})
                      away_obj = match.get('away', {}) or match.get('awayTeam', {})
                      home_full = home_obj.get('name', 'Home')
                      away_full = away_obj.get('name', 'Away')
                      
                      raw_match_name = match.get('name') or f"{home_full} vs {away_full}"
                      
                      team1 = shorten_name(home_full)
                      team2 = shorten_name(away_full)

                      # L·∫•y Logo c·ªßa 2 ƒë·ªôi (N·∫øu web c√≥ g·ª≠i v·ªÅ)
                      home_logo = home_obj.get('logo', '')
                      away_logo = away_obj.get('logo', '')

                      # Gi·ªù ƒë√°
                      time_only = "00h00"
                      timestamp = match.get('timestamp') or match.get('matchTime') or match.get('time')
                      if timestamp:
                          if isinstance(timestamp, (int, float)):
                              if timestamp > 1e11: timestamp /= 1000
                              dt = datetime.fromtimestamp(timestamp, tz=timezone.utc).astimezone(tz_vn)
                              time_only = dt.strftime("%Hh%M")
                          elif isinstance(timestamp, str):
                              m = re.search(r'(\d{2}:\d{2})', timestamp)
                              if m: time_only = m.group(1).replace(':', 'h')

                      # BLV v√† Lu·ªìng
                      blvs = match.get('blvs', [])
                      if not blvs: continue
                      blv = blvs[0]
                      blv_name = blv.get('name', 'BLV Chu·ªëi')
                      streams = blv.get('streams', [])
                      if not streams: continue

                      # 2. S·∫¢N XU·∫§T FILE JSON CON (L√ÅCH LU·∫¨T)
                      child_json = {"stream_links": []}
                      master_streams = []
                      
                      for idx, stream in enumerate(streams):
                          stream_label = stream.get('label', f"HD{idx+1}")
                          stream_url = stream.get('url')
                          if not stream_url: continue
                          
                          stream_name = f"{blv_name} - {stream_label}"
                          child_json["stream_links"].append({
                              "id": str(idx + 1),
                              "name": stream_name,
                              "type": "hls" if "m3u8" in stream_url else "flv",
                              "default": True if idx == 0 else False,
                              "url": stream_url,
                              "request_headers": [{"key": "Referer", "value": "https://api.chuoichientv.com/"}]
                          })
                          
                          remote_url = f"{BASE_REMOTE_URL}{match_id}.json"
                          master_streams.append({
                              "id": f"{match_id}_{idx}",
                              "name": stream_name,
                              "remote_data": {"url": remote_url}
                          })

                      if not master_streams: continue

                      with open(f"stream/{match_id}.json", "w", encoding="utf-8") as f:
                          json.dump(child_json, f, ensure_ascii=False, indent=2)

                      # 3. D·ª∞NG GIAO DI·ªÜN K√äNH TRONG MASTER JSON (Kh√¥ng Label Live, C·ªë ƒë·ªãnh 16:9)
                      labels_list = [
                          { "position": "bottom-center", "text": time_only, "color": "#FF0000", "text_color": "#FFFFFF" }
                      ]
                      
                      # √âp t√™n 2 ƒë·ªôi ra 2 b√™n
                      if team1: labels_list.append({ "position": "center-left", "text": team1, "color": "#80000000", "text_color": "#FFFFFF" })
                      if team2: labels_list.append({ "position": "center-right", "text": team2, "color": "#80000000", "text_color": "#FFFFFF" })
                      
                      # T√πy ch·ªçn n√¢ng cao: Th·ª≠ ch√®n th·∫≥ng ·∫£nh Logo v√†o m·∫£ng labels (N·∫øu Player h·ªó tr·ª£)
                      # if home_logo: labels_list.append({"position": "top-left", "text": "", "image": home_logo})
                      # if away_logo: labels_list.append({"position": "top-right", "text": "", "image": away_logo})

                      channel_obj = {
                          "id": match_id,
                          "name": raw_match_name,
                          "labels": labels_list,
                          "description": f"[{blv_name}] {raw_match_name} ‚Ä¢ {time_only}",
                          "image": {
                              "url": "https://raw.githubusercontent.com/nghehoang007-wq/HFB321/main/HFB/Thump/nguonphat5.png",
                              "height": 360, "width": 640, "display": "cover", "shape": "square"
                          },
                          "type": "single",
                          "display": "thumbnail-only",
                          "sources": [
                              {
                                  "id": f"src-{match_id}",
                                  "name": "Chu·ªëi Chi√™n TV",
                                  "contents": [
                                      {
                                          "id": f"cnt-{match_id}",
                                          "name": raw_match_name,
                                          "streams": master_streams
                                      }
                                  ]
                              }
                          ]
                      }

                      master_json["groups"][0]["channels"].append(channel_obj)
                      count += 1
                      
                  except Exception as ex:
                      print(f"L·ªói xu·∫•t JSON 1 tr·∫≠n: {ex}")
                      continue

              # L∆ØU FILE MASTER
              with open('chuoichientv.json', 'w', encoding='utf-8') as f:
                  json.dump(master_json, f, ensure_ascii=False, indent=2)
                  
              print(f"üéâ HO√ÄN T·∫§T: T·∫°o th√†nh c√¥ng {count} tr·∫≠n v·ªõi UI T·ªëi gi·∫£n (16:9)!")

          except Exception as e:
              print(f"‚ùå L·ªói h·ªá th·ªëng: {e}")
          EOF
          
          python3 scraper.py

      - name: Commit and Push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add -A stream/
          git add chuoichientv.json
          git commit -m "Auto Build Remote-Control JSON Factory - UI 16:9 Clean" || echo "No changes"
          git push
