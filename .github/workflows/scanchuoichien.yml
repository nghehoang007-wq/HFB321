name: Generate JSON from ChuoiChien
on:
  workflow_dispatch:
  schedule:
    - cron: '*/20 * * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - name: Install Dependencies
        # C√†i Pillow ƒë·ªÉ x·ª≠ l√Ω ·∫£nh, dateutil x·ª≠ l√Ω gi·ªù, v√† fontconfig ƒë·ªÉ qu·∫£n l√Ω font
        run: pip install curl_cffi python-dateutil Pillow

      - name: Setup Unicode Font
        # T·∫£i Font Arial Unicode v·ªÅ ƒë·ªÉ v·∫Ω ch·ªØ Ti·∫øng Vi·ªát c√≥ d·∫•u l√™n ·∫£nh
        run: |
          mkdir -p .fonts
          curl -L -o .fonts/arial.ttf "https://raw.githubusercontent.com/google/fonts/main/ofl/arimo/Arimo%5Bwght%5D.ttf"

      - name: Run ChuoiChien JSON Factory
        run: |
          # D·ªçn s·∫°ch v√† t·∫°o m·ªõi 2 th∆∞ m·ª•c
          rm -rf stream thumbs
          mkdir stream thumbs
          
          cat << 'EOF' > scraper.py
          import os
          import json
          import re
          import io
          from PIL import Image, ImageDraw, ImageFont
          from datetime import datetime, timezone, timedelta
          from curl_cffi import requests
          from dateutil import parser

          # ================= C·∫§U H√åNH API =================
          API_URL = "https://api.chuoichientv.com/v1/matches?page=1&limit=100&sport=&type=blv"
          BASE_REMOTE_URL = "https://raw.githubusercontent.com/nghehoang007-wq/HFB321/main/stream/" 
          BASE_THUMB_URL = "https://raw.githubusercontent.com/nghehoang007-wq/HFB321/main/thumbs/"
          FONT_PATH = ".fonts/arial.ttf"

          HEADERS = {
              "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJndWVzdElkIjoiZTM0Zjk3ZmQtNWMxMC00MGEzLWE1OGYtZDE3MmQwMmIxNDZjIiwidHlwZSI6Imd1ZXN0IiwiaXAiOiIxNjIuMTU5Ljk4LjIyMCIsInVzZXJBZ2VudCI6Ik1vemlsbGEvNS4wIChXaW5kb3dzIE5UIDEwLjA7IFdpbjY0OyB4NjQpIEFwcGxlV2ViS2l0LzUzNy4zNiAoS0hUTUwsIGxpa2UgR2Vja28pIENocm9tZS8xMzEuMC4wLjAgU2FmYXJpLzUzNy4zNiIsIm5hbWUiOiJCw7puIMSQ4buPIDQ1MyIsInRpbWVzdGFtcCI6MTc3MjI5MTc4NzEwNCwiaWF0IjoxNzcyMjkxNzg3LCJleHAiOjE4MDM4Mjc3ODd9.iHhwdQaDRcrjyRfCVGCbSZb6dFj-EuzJblTD1wmttV0",
              "Origin": "https://live16.chuoichientv.com",
              "Referer": "https://live16.chuoichientv.com/",
              "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
          }

          tz_vn = timezone(timedelta(hours=7))

          def shorten_name(name):
              name = str(name).strip()
              known = {"Manchester United": "Man Utd", "Manchester City": "Man City", "Barcelona": "Barca", "Villarreal": "Villarr"}
              for k, v in known.items():
                  if k.lower() in name.lower(): return v
              return name[:12] + ".." if len(name) > 13 else name

          # H√†m v·∫Ω ch·ªØ c√≥ vi·ªÅn ƒëen ƒë·ªÉ n·ªïi b·∫≠t tr√™n m·ªçi n·ªÅn ·∫£nh
          def draw_text_with_outline(draw_obj, text, position, font, text_color, outline_color, anchor="mm"):
              x, y = position
              # V·∫Ω vi·ªÅn 4 h∆∞·ªõng
              draw_obj.text((x-2, y-2), text, font=font, fill=outline_color, anchor=anchor)
              draw_obj.text((x+2, y-2), text, font=font, fill=outline_color, anchor=anchor)
              draw_obj.text((x-2, y+2), text, font=font, fill=outline_color, anchor=anchor)
              draw_obj.text((x+2, y+2), text, font=font, fill=outline_color, anchor=anchor)
              # V·∫Ω ch·ªØ ch√≠nh
              draw_obj.text(position, text, font=font, fill=text_color, anchor=anchor)

          try:
              print("ƒêang kh·ªüi ƒë·ªông x∆∞·ªüng in Thumbnail chuy√™n nghi·ªáp...")
              
              # T·∫¢I ·∫¢NH N·ªÄN
              base_bg_url = "https://raw.githubusercontent.com/nghehoang007-wq/HFB321/main/HFB/Thump/nguonphat5.png"
              try:
                  bg_res = requests.get(base_bg_url, timeout=10)
                  base_bg = Image.open(io.BytesIO(bg_res.content)).convert("RGBA")
                  base_bg = base_bg.resize((640, 360))
              except:
                  base_bg = Image.new('RGBA', (640, 360), (0, 0, 0, 255))

              # LOAD FONT (C·ª° 48 cho t√™n ƒë·ªôi, 28 cho gi·ªù, 64 cho VS)
              try:
                  team_font = ImageFont.truetype(FONT_PATH, 48) # To h∆°n 32
                  time_font = ImageFont.truetype(FONT_PATH, 28)
                  vs_font = ImageFont.truetype(FONT_PATH, 64)
              except:
                  team_font = ImageFont.load_default()
                  time_font = ImageFont.load_default()
                  vs_font = ImageFont.load_default()

              response = requests.get(API_URL, headers=HEADERS, impersonate="chrome110", timeout=30)
              data = response.json()
              matches = data.get('matches', [])

              master_json = {
                  "id": "chuoichienhfb",
                  "url": "https://nghehoang007-wq.github.io/HFB321/chuoichientv.json",
                  "name": "Chu·ªëi Chi√™n TV",
                  "color": "#003A17",
                  "description": "C·∫≠p nh·∫≠t tr·ª±c ti·∫øp t·ª´ Chu·ªëi Chi√™n TV",
                  "image": {"url": "https://raw.githubusercontent.com/nghehoang007-wq/HFB321/main/HFB/Thump/chuoichien.png?v1"},
                  "groups": [{"id": "live", "name": "üî¥ TR·ª∞C TI·∫æP CHU·ªêI CHI√äN", "display": "vertical", "grid_number": 2, "channels": []}],
                  "notice": {"id": "notice", "link": "https://t.me/xemgicungshare", "icon": "https://tt.8share.pro/assets/telegram_sp.png", "closeable": True},
                  "option": {"save_history": False, "save_search_history": False, "save_wishlist": False}
              }
              
              count = 0
              for match in matches:
                  try:
                      match_id = match.get('_id')
                      teams_data = match.get('teams', {})
                      home_data = teams_data.get('home', {})
                      away_data = teams_data.get('away', {})
                      
                      team1_full = home_data.get('name', 'Home')
                      team2_full = away_data.get('name', 'Away')
                      team1_short = shorten_name(team1_full)
                      team2_short = shorten_name(team2_full)
                      home_logo_url = home_data.get('logo', '')
                      away_logo_url = away_data.get('logo', '')

                      # X·ª¨ L√ù TH·ªúI GIAN
                      match_time_raw = match.get('matchTime', '')
                      time_display = "00h00"
                      if match_time_raw:
                          try:
                              dt = parser.parse(match_time_raw).astimezone(tz_vn)
                              time_display = dt.strftime("%Hh%M")
                          except: pass

                      blvs_list = match.get('blvs', [])
                      if not blvs_list: continue
                      blv = blvs_list[0]
                      blv_name = blv.get('name', 'Chu·ªëi')
                      streams = blv.get('streams', [])
                      if not streams: continue

                      # -- X∆Ø·ªûNG PHOTOSHOP CHUY√äN NGHI·ªÜP: V·∫º T·∫§T C·∫¢ V√ÄO ·∫¢NH --
                      # Do che b·∫±ng h·ªôp vƒÉn b·∫£n m·ªõi, n√™n b∆∞·ªõc che s√¢n c·ªè l√† kh√¥ng c·∫ßn thi·∫øt,
                      # t√¥i ch·ªâ c·∫ßn d√°n h·ªôp vƒÉn b·∫£n m·ªõi ƒë√® l√™n.
                      thumb_url = f"{BASE_REMOTE_URL}HFB/Thump/nguonphat5.png" # M·∫∑c ƒë·ªãnh

                      try:
                          # Re-create background s·∫°ch 640x360
                          # Ho·∫∑c cheat b·∫±ng c√°ch d√°n h·ªôp vƒÉn b·∫£n ƒë√®. T·ªët h∆°n l√† *re-create* background s·∫°ch.
                          # Do che b·∫±ng h·ªôp vƒÉn b·∫£n m·ªõi, n√™n b∆∞·ªõc che s√¢n c·ªè l√† kh√¥ng c·∫ßn thi·∫øt.

                          # T·∫£i image_1.png l√†m n·ªÅn. Thu h·∫πp xu·ªëng 640x360.
                          bg_copy = base_bg.copy()
                          draw = ImageDraw.Draw(bg_copy)
                          has_custom_thumb = False
                          
                          # B·ªë c·ª•c tr·ª•c d·ªçc m·ªõi: LOGO (th·∫•p h∆°n) -> T√äN ƒê·ªòI (th·∫•p h∆°n, to h∆°n, d∆∞·ªõi logo) -> GI·ªú ƒê√Å
                          #

                          # K√≠ch th∆∞·ªõc ·∫£nh n·ªÅn: R·ªông 640px, Cao 360px
                          # Tr·ª•c d·ªçc gi·ªØa l√† Y=180.

                          # 1. Thu nh·ªè v√† d√°n LOGO xu·ªëng th·∫•p h∆°n (v√≠ d·ª• Y=220)
                          if home_logo_url:
                              h_res = requests.get(home_logo_url, timeout=5)
                              if h_res.status_code == 200:
                                  h_img = Image.open(io.BytesIO(h_res.content)).convert("RGBA")
                                  h_img = h_img.resize((100, 100)) # 100x100
                                  # D√°n logo b√™n tr√°i, Y=220
                                  bg_copy.paste(h_img, (110, 220), h_img)
                                  has_custom_thumb = True
                                  
                          if away_logo_url:
                              a_res = requests.get(away_logo_url, timeout=5)
                              if a_res.status_code == 200:
                                  a_img = Image.open(io.BytesIO(a_res.content)).convert("RGBA")
                                  a_img = a_img.resize((100, 100)) # 100x100
                                  # D√°n logo b√™n ph·∫£i, Y=220
                                  bg_copy.paste(a_img, (430, 220), a_img)
                                  has_custom_thumb = True

                          # 2. V·∫Ω T√äN ƒê·ªòI (to h∆°n, th·∫•p h∆°n, d∆∞·ªõi logo - v√≠ d·ª• Y=300)
                          # ƒê·ªôi nh√† d·∫°t sang tr√°i 1/4 (X=160), ƒê·ªôi kh√°ch d·∫°t sang ph·∫£i 3/4 (X=480)
                          # Ph√¥ng ch·ªØ c·ª° 48
                          draw_text_with_outline(draw, team1_short, (160, 300), team_font, (255, 255, 255, 255), (0, 0, 0, 255))
                          draw_text_with_outline(draw, team2_short, (480, 300), team_font, (255, 255, 255, 255), (0, 0, 0, 255))

                          # 3. V·∫Ω VS ( center-center, to h∆°n, m√†u v√†ng)
                          # Ph√¥ng ch·ªØ c·ª° 64
                          draw_text_with_outline(draw, "VS", (320, 180), vs_font, (255, 255, 0, 255), (0, 0, 0, 255))

                          # 4. V·∫Ω Gi·ªù ƒë√° (bottom-center, m√†u ƒë·ªè)
                          # Ph√¥ng ch·ªØ c·ª° 28
                          draw_text_with_outline(draw, time_display, (320, 320), time_font, (255, 0, 0, 255), (0, 0, 0, 255))

                          if has_custom_thumb:
                              thumb_path = f"thumbs/{match_id}.png"
                              bg_copy.save(thumb_path, "PNG")
                              thumb_url = f"{BASE_THUMB_URL}{match_id}.png"
                              
                      except Exception as e:
                          print(f"L·ªói t·∫°o ·∫£nh tr·∫≠n {match_id}: {e}")

                      # -- T·∫†O FILE JSON CON --
                      child_json = {"stream_links": []}
                      master_streams = []
                      for idx, s in enumerate(streams):
                          s_url = s.get('url')
                          s_name = f"{blv_name} - {s.get('label', 'HD')}"
                          if not s_url: continue
                          
                          child_json["stream_links"].append({
                              "id": str(idx+1), "name": s_name, "type": "hls" if "m3u8" in s_url else "flv",
                              "url": s_url, "default": idx==0,
                              "request_headers": [{"key": "Referer", "value": "https://api.chuoichientv.com/"}]
                          })
                          master_streams.append({"id": f"{match_id}_{idx}", "name": s_name, "remote_data": {"url": f"{BASE_REMOTE_URL}{match_id}.json"}})

                      if not master_streams: continue
                      with open(f"stream/{match_id}.json", "w", encoding="utf-8") as f:
                          json.dump(child_json, f, ensure_ascii=False, indent=2)

                      # -- GIAO DI·ªÜN MASTER JSON (X√ìA B·ªé LABELS, CH·ªà D√ôNG ·∫¢NH PHOTOSHOP) --
                      # ƒê·∫£m b·∫£o `groups.channels` l√† `[]` v√† `grid_number` l√† 2.
                      master_json["groups"][0]["channels"].append({
                          "id": match_id, 
                          "name": f"{team1_full} vs {team2_full}",
                          "labels": [], # M·∫£ng nh√£n r·ªóng tuy·ªát ƒë·ªëi!
                          "image": {"url": thumb_url, "height": 360, "width": 640, "display": "cover"},
                          "type": "single", 
                          "display": "thumbnail-only",
                          "sources": [{"id": f"src-{match_id}", "name": "Chu·ªëi Chi√™n", "contents": [{"id": f"c-{match_id}", "name": f"{team1_full} vs {team2_full}", "streams": master_streams}]}]
                      })
                      count += 1
                  except Exception as e:
                      print(f"B·ªè qua 1 tr·∫≠n do l·ªói: {e}")
                      continue

              with open('chuoichientv.json', 'w', encoding='utf-8') as f:
                  json.dump(master_json, f, ensure_ascii=False, indent=2)
              print(f"üéâ TH√ÄNH C√îNG R·ª∞C R·ª†! In xong Thumbnail cho {count} tr·∫≠n.")
          except Exception as e: 
              print(f"L·ªói t·ªïng th·ªÉ: {e}")
          EOF
          python3 scraper.py

      - name: Commit and Push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add -A stream/ thumbs/ chuoichientv.json
          git commit -m "UI: Professional Vertical Layout (Logos Top, Large Team Names Bottom, Time Center), cheold background clean" || echo "No changes"
          git push
