name: Generate M3U from ChuoiChien
on:
  workflow_dispatch:
  schedule:
    - cron: '*/20 * * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - name: Install Dependencies
        run: pip install curl_cffi

      - name: Run ChuoiChien API Scraper
        run: |
          cat << 'EOF' > scraper.py
          from curl_cffi import requests
          import json
          import re
          import unicodedata
          from datetime import datetime

          # D√πng ƒë∆∞·ªùng link tuy·ªát h·∫£o m√† b√°c v·ª´a t√¨m ƒë∆∞·ª£c (L·∫•y t·ªëi ƒëa 100 tr·∫≠n c√≥ BLV)
          API_URL = "https://api.chuoichientv.com/v1/matches?page=1&limit=100&sport=&type=blv"
          URL_PREFIX = "https://gckc0525.edgemaxcdn.org/live/"
          URL_SUFFIX = ".flv"

          def generate_stream_id(blv_name):
              name = str(blv_name).strip().lower()
              no_accent = unicodedata.normalize('NFKD', name).encode('ASCII', 'ignore').decode('utf-8')
              return re.sub(r'[^a-z0-9]', '', no_accent)

          try:
              print(f"ƒêang ƒë√¢m th·∫≥ng v√†o API: {API_URL}")
              response = requests.get(API_URL, impersonate="chrome110", timeout=30)
              
              if response.status_code != 200:
                  print(f"‚ö†Ô∏è API b√°o l·ªói: {response.status_code}")
              
              data = response.json()
              
              # D√≤ t√¨m danh s√°ch tr·∫≠n ƒë·∫•u (Th∆∞·ªùng n·∫±m trong bi·∫øn 'data' ho·∫∑c 'items')
              matches = data.get('data', [])
              if not matches and isinstance(data, list):
                  matches = data

              if not matches:
                  print("‚ö†Ô∏è API k·∫øt n·ªëi th√†nh c√¥ng nh∆∞ng kh√¥ng c√≥ tr·∫≠n n√†o ho·∫∑c c·∫•u tr√∫c JSON kh√°c d·ª± ki·∫øn.")
                  print("N·ªôi dung API tr·∫£ v·ªÅ:", str(data)[:500])
              else:
                  print(f"üîç B·∫Øt ƒë∆∞·ª£c {len(matches)} tr·∫≠n ƒë·∫•u t·ª´ API. ƒêang ph√¢n t√≠ch JSON...")
                  # IN RA C·∫§U TR√öC JSON C·ª¶A TR·∫¨N ƒê·∫¶U TI√äN ƒê·ªÇ L√ÄM MANH M·ªêI (PH√íNG H·ªú)
                  print("--- C·∫§U TR√öC M·∫™U 1 TR·∫¨N ƒê·∫§U ---")
                  print(json.dumps(matches[0], indent=2, ensure_ascii=False)[:1000])
                  print("--------------------------------")

              m3u_lines = ["#EXTM3U"]
              count = 0
              
              for match in matches:
                  try:
                      # D√≤ t√¨m t√™n ƒë·ªôi (ƒêo√°n c√°c bi·∫øn ph·ªï bi·∫øn)
                      home = match.get('homeTeam', {}).get('name') or match.get('home', {}).get('name') or match.get('team1') or "Home"
                      away = match.get('awayTeam', {}).get('name') or match.get('away', {}).get('name') or match.get('team2') or "Away"
                      match_name = f"{home} vs {away}"

                      # D√≤ t√¨m t√™n BLV
                      blv_name = ""
                      commentators = match.get('commentators') or match.get('blvs')
                      if isinstance(commentators, list) and len(commentators) > 0:
                          blv = commentators[0]
                          blv_name = blv.get('name') if isinstance(blv, dict) else str(blv)
                      else:
                          blv_name = match.get('commentator_name') or match.get('blv') or ""

                      if not blv_name:
                          continue # B·ªè qua n·∫øu kh√¥ng c√≥ BLV

                      # D√≤ t√¨m th·ªùi gian
                      time_str = "00h00"
                      timestamp = match.get('timestamp') or match.get('startTime') or match.get('start_time')
                      if timestamp:
                          # Chuy·ªÉn ƒë·ªïi Unix time (n·∫øu l√† s·ªë)
                          if isinstance(timestamp, (int, float)):
                              if timestamp > 1e11: timestamp /= 1000 # ƒê·ªïi millisecond ra second
                              dt = datetime.fromtimestamp(timestamp)
                              time_str = dt.strftime("%Hh%M-%d/%m")
                          elif isinstance(timestamp, str):
                              time_str = timestamp[:16].replace('T', ' ').replace(':', 'h') # Ch·ªØa ch√°y n·∫øu l√† chu·ªói ISO

                      # T·∫°o Link v√† L∆∞u
                      stream_id = generate_stream_id(blv_name)
                      stream_url = f"{URL_PREFIX}{stream_id}{URL_SUFFIX}"

                      display_text = f"ChuoiChien {time_str}: [{blv_name}] {match_name}"
                      m3u_lines.append(f'#EXTINF:-1 group-title="ChuoiChien",{display_text}')
                      m3u_lines.append(stream_url)
                      count += 1
                      
                  except Exception as ex:
                      continue

              with open('chuoichientv.m3u', 'w', encoding='utf-8') as f:
                  f.write("\n".join(m3u_lines))
                  
              print(f"üéâ T·ªîNG K·∫æT: C√†o API si√™u t·ªëc th√†nh c√¥ng {count} lu·ªìng ph√°t!")

          except Exception as e:
              print(f"‚ùå L·ªói h·ªá th·ªëng: {e}")
              with open('chuoichientv.m3u', 'w', encoding='utf-8') as f:
                  f.write("#EXTM3U\n")
          EOF
          
          python3 scraper.py

      - name: Commit and Push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add chuoichientv.m3u
          git commit -m "Auto Scrape ChuoiChien TV via API" || echo "No changes"
          git push
