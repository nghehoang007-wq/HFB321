name: Generate M3U from ChuoiChien
on:
  workflow_dispatch:
  schedule:
    - cron: '*/20 * * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - name: Install Dependencies
        run: pip install cloudscraper beautifulsoup4

      - name: Run ChuoiChien Scraper
        run: |
          cat << 'EOF' > scraper.py
          import cloudscraper
          from bs4 import BeautifulSoup
          import re
          import unicodedata

          TARGET_URL = "https://live16.chuoichientv.com/lich-thi-dau"
          URL_PREFIX = "https://gckc0525.edgemaxcdn.org/live/"
          URL_SUFFIX = ".flv"

          def generate_stream_id(blv_name):
              name = blv_name.strip().lower()
              no_accent = unicodedata.normalize('NFKD', name).encode('ASCII', 'ignore').decode('utf-8')
              stream_id = re.sub(r'[^a-z0-9]', '', no_accent)
              return stream_id

          scraper = cloudscraper.create_scraper(browser={'browser': 'chrome', 'platform': 'windows', 'mobile': False})
          
          try:
              print(f"Đang cào dữ liệu từ: {TARGET_URL}")
              html = scraper.get(TARGET_URL, timeout=15).text
              soup = BeautifulSoup(html, 'html.parser')
              
              m3u_lines = ["#EXTM3U"]
              count = 0
              
              # DÙNG CSS SELECTOR ĐỂ TÌM LINK TRẬN ĐẤU (Tuyệt đối không trượt)
              matches = soup.select('a[href*="/live/"]')
              
              for match in matches:
                  try:
                      # 1. Bóc Tên Đội Bóng (Lấy các thẻ div có chứa 2 class là font-bold VÀ text-white)
                      team_divs = match.select('div.font-bold.text-white')
                      if len(team_divs) < 2:
                          continue
                      team1 = team_divs[0].get_text(strip=True)
                      team2 = team_divs[1].get_text(strip=True)
                      match_name = f"{team1} vs {team2}"

                      # 2. Bóc Thời Gian
                      time_span = match.select_one('span.text-green-300')
                      if time_span:
                          time_str = time_span.get_text(strip=True).replace(' ', '-').replace(':', 'h')
                      else:
                          time_str = "00:00"

                      # 3. Bóc Tên BLV
                      blv_span = match.select_one('span.blv-info')
                      if not blv_span:
                          continue 
                          
                      blv_name = blv_span.get_text(strip=True)
                      if not blv_name:  # Bỏ qua nếu trận này có khối HTML nhưng chưa điền tên BLV
                          continue

                      # 4. Sinh ID
                      stream_id = generate_stream_id(blv_name)
                      stream_url = f"{URL_PREFIX}{stream_id}{URL_SUFFIX}"

                      # 5. Ghi vào M3U
                      display_text = f"ChuoiChien {time_str}: [{blv_name}] {match_name}"
                      m3u_lines.append(f'#EXTINF:-1 group-title="ChuoiChien",{display_text}')
                      m3u_lines.append(stream_url)
                      count += 1
                      
                  except Exception as ex:
                      continue

              with open('chuoichientv.m3u', 'w', encoding='utf-8') as f:
                  f.write("\n".join(m3u_lines))
                  
              print(f"✅ Quét thành công! Cào được {count} luồng phát từ Chuối Chiên TV.")

          except Exception as e:
              print(f"❌ Lỗi: {e}")
              with open('chuoichientv.m3u', 'w', encoding='utf-8') as f:
                  f.write("#EXTM3U\n")
          EOF
          
          python3 scraper.py

      - name: Commit and Push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add chuoichientv.m3u
          git commit -m "Auto Scrape ChuoiChien TV using CSS Selectors" || echo "No changes"
          git push
