name: Update IPTV JSON List
on:
  workflow_dispatch:
  schedule:
    # Ch·∫°y 20 ph√∫t 1 l·∫ßn
    - cron: '*/20 * * * *'

jobs:
  generate-json:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - name: Fetch and Convert M3U to JSON
        run: |
          # 1. T·∫£i file g·ªëc
          curl -s -L "https://raw.githubusercontent.com/minhtan001/IPTV-Auto/refs/heads/playlists/all.m3u" > raw.m3u
          
          # 2. T·∫°o script Python x·ª≠ l√Ω logic
          cat << 'EOF' > convert.py
          import json
          import re

          # C·∫•u tr√∫c khung JSON c∆° b·∫£n
          data = {
            "id": "HFB",
            "url": "http://hfb123.netlify.app/MT.json",
            "name": "HFB",
            "color": "#1cb57a",
            "description": "HFB - Trang web ph√°t s√≥ng b√≥ng ƒë√° tr·ª±c tuy·∫øn mi·ªÖn ph√≠ h√†ng ƒë·∫ßu t·∫°i Vi·ªát Nam.",
            "image": {
              "url": "https://t4.ftcdn.net/jpg/02/11/51/53/360_F_211515361_bnIbyKadClzn3hJT0zCPPuPApcG7k3lC.jpg"
            },
            "groups": [
              {
                "id": "live",
                "name": "üî¥ Live",
                "display": "horizontal",
                "grid_number": 2,
                "channels": [],
                "remote_data": {
                  "url": "http://tt.8share.pro/buncha/group/live"
                }
              }
            ]
          }

          # ƒê·ªçc file M3U
          try:
              with open('raw.m3u', 'r', encoding='utf-8') as f:
                  lines = [line.strip() for line in f if line.strip()]
          except Exception as e:
              lines = []
              print("L·ªói ƒë·ªçc file:", e)

          channels = []

          # Duy·ªát t·ª´ng d√≤ng ƒë·ªÉ t√¨m tr·∫≠n ƒë·∫•u
          for i in range(len(lines)):
              line = lines[i]
              
              # L·ªçc: Ch·ªâ l·∫•y c√°c d√≤ng c√≥ ch·ª©a Socolive
              if line.startswith('#EXTINF') and 'Socolive' in line:
                  
                  # C·∫Øt t·∫°i d·∫•u ph·∫©y ƒê·∫¶U TI√äN ƒë·ªÉ l·∫•y ph·∫ßn n·ªôi dung hi·ªÉn th·ªã
                  # V√≠ d·ª•: "15h35: [BLV LONG] Melbourne City vs Melbourne Victory"
                  parts = line.split(',', 1)
                  if len(parts) > 1:
                      display_text = parts[1].strip()
                      
                      # D√πng Regex ƒë·ªÉ b√≥c t√°ch: Th·ªùi gian, BLV, T√™n tr·∫≠n
                      match_info = re.match(r'(.*?):\s*\[(.*?)\]\s*(.*)', display_text)
                      
                      if match_info:
                          time_str = match_info.group(1).strip()  # L·∫•y "15h35"
                          blv_name = match_info.group(2).strip()  # L·∫•y "BLV LONG"
                          match_name = match_info.group(3).strip() # L·∫•y "Melbourne City vs ..."
                      else:
                          # Fallback n·∫øu t√™n kh√¥ng ƒë√∫ng chu·∫©n ngo·∫∑c vu√¥ng
                          time_str = "Live"
                          blv_name = "BLV Socolive"
                          match_name = display_text

                      # X·ª≠ l√Ω URL ·ªü d√≤ng ti·∫øp theo
                      if i + 1 < len(lines) and lines[i+1].startswith('http'):
                          raw_url = lines[i+1]
                          
                          # Tr√≠ch xu·∫•t s·ªë ID t·ª´ chu·ªói "id=9912050"
                          id_match = re.search(r'id=(\d+)', raw_url)
                          if id_match:
                              stream_id = id_match.group(1) # L·∫•y "9912050"
                              
                              # B∆°m ID v√†o c√¥ng th·ª©c URL m·ªõi
                              new_stream_url = f"https://live.inplyr.com/room/{stream_id}.m3u8"
                              
                              # T·∫°o c·∫•u tr√∫c cho 1 tr·∫≠n ƒë·∫•u
                              channel_obj = {
                                "id": f"socolive-{stream_id}",
                                "name": match_name,
                                "labels": [
                                  {
                                    "position": "bottom-left",
                                    "text": blv_name,
                                    "color": "#0066CC",
                                    "text_color": "#FFFFFF"
                                  },
                                  {
                                    "position": "top-left",
                                    "text": "‚óè Live",
                                    "color": "#FF0000",
                                    "text_color": "#FFFFFF"
                                  },
                                  {
                                    "position": "center",
                                    "text": time_str,
                                    "color": "#0066CC",
                                    "text_color": "#FFFFFF"
                                  }
                                ],
                                "description": f"Socolive ‚Ä¢ {time_str}",
                                "image": {
                                  "url": "https://raw.githubusercontent.com/nghehoang007-wq/HFB321/main/HFB/Thump/nguonphat1.png",
                                  "height": 480, "width": 640, "display": "cover", "shape": "square"
                                },
                                "type": "single",
                                "display": "thumbnail-only",
                                "sources": [
                                  {
                                    "id": f"source-{stream_id}",
                                    "name": "Socolive",
                                    "contents": [
                                      {
                                        "id": f"content-{stream_id}",
                                        "name": match_name,
                                        "streams": [
                                          {
                                            "id": f"stream-{stream_id}",
                                            "name": blv_name,
                                            "stream_links": [
                                              {
                                                "id": f"link-{stream_id}",
                                                "name": "HLS",
                                                "type": "hls",
                                                "default": True,
                                                "url": new_stream_url,
                                                "request_headers": [
                                                  {
                                                    "key": "Referer",
                                                    "value": "https://bunchatv3.com/"
                                                  }
                                                ]
                                              }
                                            ]
                                          }
                                        ]
                                      }
                                    ]
                                  }
                                ]
                              }
                              # Th√™m tr·∫≠n ƒë·∫•u v√†o danh s√°ch
                              channels.append(channel_obj)

          # B∆°m to√†n b·ªô danh s√°ch tr·∫≠n ƒë·∫•u v√†o kh·ªëi groups
          data['groups'][0]['channels'] = channels

          # Xu·∫•t ra file JSON m·ªõi
          with open('MT.json', 'w', encoding='utf-8') as f:
              json.dump(data, f, ensure_ascii=False, indent=2)
          EOF
          
          # 3. Ch·∫°y script
          python3 convert.py
          
          # 4. Ki·ªÉm tra v√† ƒë·∫©y file JSON l√™n GitHub
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add MT.json
          git commit -m "Auto update JSON playlist from Socolive matches" || echo "No changes to commit"
          git push
